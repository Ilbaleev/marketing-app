<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ–º</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .menu-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
        }
        
        .menu-button:hover {
            opacity: 0.8;
        }
        
        .stats {
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        
        .task-list {
            margin-top: 20px;
        }
        
        .task-item {
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid var(--tg-theme-button-color);
        }
        
        .task-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .task-description {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin-bottom: 10px;
        }
        
        .task-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--tg-theme-hint-color);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color);
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #ff4444;
            background-color: rgba(255, 68, 68, 0.1);
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .back-button {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-button-color);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <div id="dashboard" class="page active">
            <div class="header">
                <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
                <p id="welcome">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</p>
            </div>
            
            <div class="stats">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
                <div class="stat-item">
                    <span>–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:</span>
                    <strong id="activeTasks">-</strong>
                </div>
                <div class="stat-item">
                    <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è:</span>
                    <strong id="completedTasks">-</strong>
                </div>
                <div class="stat-item">
                    <span>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ:</span>
                    <strong id="overdueTasks">-</strong>
                </div>
            </div>
            
            <button class="menu-button" onclick="showTasks()">üìã –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏</button>
            <button class="menu-button" onclick="showAnalytics()">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
            <button class="menu-button" onclick="showTeam()">üë• –ö–æ–º–∞–Ω–¥–∞</button>
            <button class="menu-button" onclick="showSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–¥–∞—á -->
        <div id="tasks" class="page">
            <button class="back-button" onclick="showDashboard()">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ú–æ–∏ –∑–∞–¥–∞—á–∏</h2>
            <div id="tasksContent">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const CONFIG = {
            // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® WEBHOOK URL –û–¢ –ë–ò–¢–†–ò–ö–°24
            BITRIX_WEBHOOK: 'https://mpb.bitrix24.kz/rest/13/f92fhs0h39vmg991/',
            
            // –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Telegram ID –∏ Bitrix24 User ID
            USER_MAPPING: {
                '721249582': '13',
                // –î–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤–∞—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                // 'telegram_id': 'bitrix_user_id'
                // –ü—Ä–∏–º–µ—Ä:
                // '123456789': '1',
                // '987654321': '2'
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        let currentUser = null;
        let bitrixUserId = null;
        
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        tg.ready();
        tg.expand();
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let user = tg.initDataUnsafe.user;
        if (user) {
            currentUser = user;
            document.getElementById('welcome').textContent = 
                `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.first_name}!`;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–∏—Ç—Ä–∏–∫—Å24
            bitrixUserId = CONFIG.USER_MAPPING[user.id.toString()];
            if (!bitrixUserId) {
                console.warn('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –º–∞–ø–ø–∏–Ω–≥–µ:', user.id);
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º ID 1 (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
                bitrixUserId = '1';
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadDashboardStats();
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
        tg.BackButton.show();
        tg.BackButton.onClick(function() {
            const activePage = document.querySelector('.page.active');
            if (activePage.id === 'dashboard') {
                tg.close();
            } else {
                showDashboard();
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        function showDashboard() {
            showPage('dashboard');
            loadDashboardStats();
        }

        function showTasks() {
            showPage('tasks');
            loadUserTasks();
        }

        function showAnalytics() {
            tg.showAlert('–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö');
        }

        function showTeam() {
            tg.showAlert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–∞–Ω–¥–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö');
        }

        function showSettings() {
            tg.showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö');
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–∏—Ç—Ä–∏–∫—Å24
        async function callBitrixAPI(method, params = {}) {
            try {
                const url = new URL(CONFIG.BITRIX_WEBHOOK + method + '.json');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL
                Object.keys(params).forEach(key => {
                    if (typeof params[key] === 'object') {
                        Object.keys(params[key]).forEach(subKey => {
                            url.searchParams.append(`${key}[${subKey}]`, params[key][subKey]);
                        });
                    } else {
                        url.searchParams.append(key, params[key]);
                    }
                });

                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error_description || data.error);
                }

                return data.result;
            } catch (error) {
                console.error('Bitrix API Error:', error);
                throw error;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
        async function loadDashboardStats() {
            if (!bitrixUserId) return;

            try {
                // –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const tasks = await callBitrixAPI('tasks.task.list', {
                    filter: {
                        'RESPONSIBLE_ID': bitrixUserId
                    },
                    select: ['ID', 'STATUS', 'DEADLINE', 'CREATED_DATE']
                });

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let activeTasks = 0;
                let completedToday = 0;
                let overdueTasks = 0;

                tasks.tasks.forEach(task => {
                    // –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ (—Å—Ç–∞—Ç—É—Å –º–µ–Ω—å—à–µ 5 = –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã)
                    if (parseInt(task.STATUS) < 5) {
                        activeTasks++;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ
                        if (task.DEADLINE) {
                            const deadline = new Date(task.DEADLINE);
                            if (deadline < today) {
                                overdueTasks++;
                            }
                        }
                    }
                    
                    // –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è (—Å—Ç–∞—Ç—É—Å 5 = –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
                    if (parseInt(task.STATUS) === 5) {
                        const closedDate = new Date(task.CLOSED_DATE || task.CREATED_DATE);
                        if (closedDate >= today) {
                            completedToday++;
                        }
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('activeTasks').textContent = activeTasks;
                document.getElementById('completedTasks').textContent = completedToday;
                document.getElementById('overdueTasks').textContent = overdueTasks;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                document.getElementById('activeTasks').textContent = '–û—à–∏–±–∫–∞';
                document.getElementById('completedTasks').textContent = '–û—à–∏–±–∫–∞';
                document.getElementById('overdueTasks').textContent = '–û—à–∏–±–∫–∞';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserTasks() {
            const container = document.getElementById('tasksContent');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div>';

            if (!bitrixUserId) {
                container.innerHTML = '<div class="error">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ</div>';
                return;
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const tasks = await callBitrixAPI('tasks.task.list', {
                    filter: {
                        'RESPONSIBLE_ID': bitrixUserId,
                        '<STATUS': 5  // –°—Ç–∞—Ç—É—Å –º–µ–Ω—å—à–µ 5 (–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
                    },
                    select: ['ID', 'TITLE', 'DESCRIPTION', 'STATUS', 'DEADLINE', 'PRIORITY', 'CREATED_BY'],
                    order: {
                        'DEADLINE': 'ASC'
                    }
                });

                if (!tasks.tasks || tasks.tasks.length === 0) {
                    container.innerHTML = '<div class="loading">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</div>';
                    return;
                }

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–¥–∞—á–∏
                let tasksHTML = '';
                tasks.tasks.forEach(task => {
                    const deadline = task.DEADLINE ? new Date(task.DEADLINE).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω';
                    const priority = task.PRIORITY === '2' ? 'üî•' : task.PRIORITY === '1' ? '‚ö°' : '';
                    const status = getTaskStatusText(task.STATUS);
                    
                    tasksHTML += `
                        <div class="task-item">
                            <div class="task-title">${priority} ${task.TITLE}</div>
                            <div class="task-description">${task.DESCRIPTION || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</div>
                            <div class="task-meta">
                                <span>–°—Ç–∞—Ç—É—Å: ${status}</span>
                                <span>–°—Ä–æ–∫: ${deadline}</span>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = tasksHTML;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
                container.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: ${error.message}</div>`;
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏
        function getTaskStatusText(status) {
            const statusMap = {
                '1': '–ù–æ–≤–∞—è',
                '2': '–û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è',
                '3': '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è',
                '4': '–û–∂–∏–¥–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è',
                '5': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
                '6': '–û—Ç–ª–æ–∂–µ–Ω–∞',
                '7': '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞'
            };
            return statusMap[status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º Telegram —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
        tg.ready();
    </script>
</body>
</html>
